# Kickstart file automatically generated by anaconda.
#version=F9
install

# all updates are on the iso, but creating a blank repo on the 
# usbkey and we could leave this in. DO NOT REMOVE, mkusbinstall
# will enable this line if there are updates available

#repo --name=XSupdates --baseurl=file:///mnt/isodir/XSUpdates

# without confuses the installer use repo= on the boot cmd line
 
harddrive --partition=LABEL=XSREPO --dir=iso

lang en_US.UTF-8
keyboard us

# System services
services --disabled=netfs,nfs,nfslock,rpcbind,rpcgssd,rpcidmapd,rpcsvcgssd,avahi-dnsconfd,radvd,ip6tables,dc_client,dc_server,squid,autofs,gpm,yum-updatesd,dhcpd,iptables,kdump,hddtemp,aiccu,firstboot --enabled=dhcdbd,network,sshd,haldaemon,smartd,anacron,crond,atd,incron,avahi-daemon,named,ntpd,messagebus,pgsql-xs,httpd,ejabberd
firewall --enabled --port=22:tcp
authconfig --useshadow --enablemd5
selinux --disabled

bootloader --location=mbr --driveorder=sda,sdb --append="quiet"
%include /mnt/isodir/part.cfg

%packages --nobase
@admin-tools
kernel
xs-pkgs
rootfiles
passwd
xs-release
xs-config
authconfig
chkconfig
policycoreutils
bash
-selinux-policy-targeted
-fedora-release
-gnome-packagekit
-authconfig-gtk
%end

%post
# can't hurt adding local alias
cat > /etc/hosts.in <<EOF
127.0.0.1               schoolserver.@@BASEDNSNAME@@ localhost.localdomain localhost schoolserver
::1                     localhost6.localdomain6 localhost6
EOF

#setup named tpl file, fixes insecure warning also.
cp  /etc/named-xs.conf.in /etc/named-xs.conf.tpl.in 
sed -i -e "s/query-source    port 53;/forwarders	{@@BASEDNSFWD@@ };/" /etc/named-xs.conf.tpl.in
sed -i -e "s/listen-on { 172.18.0.1; 127.0.0.1; };/listen-on { any; };/" /etc/named-xs.conf.tpl.in
sed -i -e "s/172.18.0.1/127.0.0.1/" /var/named-xs/school.internal.zone.db
sed -i -e "s/172.18.0.1/127.0.0.1/" /etc/sysconfig/olpc-scripts/resolv.conf.in

# add /etc/named-xs.conf.tpl to domain_config
sed -i -e "s|/etc/named-xs.conf|/etc/named-xs.conf /etc/named-xs.conf.tpl|" /etc/sysconfig/olpc-scripts/domain_config.d/named

#edit the *.in files
#place #Listen in  /etc/httpd/conf/httpd-xs.conf
sed -i -e "s/Listen/#Listen/" /etc/httpd/conf/httpd-xs.conf
sed -i -e "s/#Listen 172.18.0.1:80/Listen 80/" /etc/httpd/conf/httpd-xs.conf

# fix xinetd.d services
# xs-rsyncd xsactivation 
sed -i -e "s/172.18.0.1/0.0.0.0/" /etc/xinetd.d/xs-rsyncd 
sed -i -e "s/172.18.0.1/0.0.0.0/" /etc/xinetd.d/xsactivation  

# fix idmgr
sed -i -e "s/BIND_ADDRESS=172.18.0.1/BIND_ADDRESS='0.0.0.0'/" /etc/idmgr.conf.in

# fix domain_config to ignore network.in
# might generate a warning when domain_config is run
rm -f /etc/sysconfig/network.in

%include /mnt/isodir/local.cfg

# setting domain_config from local.cfg runs first. 
# rerun to pickup above change, would set default if local.cfg fails
/etc/sysconfig/olpc-scripts/domain_config

# then clean up network here
rm -f /etc/sysconfig/network-scripts/route-lanbond0 
rm -f /etc/sysconfig/network-scripts/route-eth0 
rm -f /etc/sysconfig/network-scripts/ifcfg-mshbond0
rm -f /etc/sysconfig/network-scripts/ifcfg-mshbond1
rm -f /etc/sysconfig/network-scripts/ifcfg-mshbond2
rm -f /etc/sysconfig/network-scripts/ifcfg-msh0
rm -f /etc/sysconfig/network-scripts/ifcfg-msh1
rm -f /etc/sysconfig/network-scripts/ifcfg-msh2
rm -f /etc/sysconfig/network-scripts/ifcfg-wmesh0
rm -f /etc/sysconfig/network-scripts/ifcfg-wmesh1 
rm -f /etc/sysconfig/network-scripts/ifcfg-wmesh2
rm -f /etc/sysconfig/network-scripts/ifcfg-eth1
rm -f /etc/sysconfig/network-scripts/ifcfg-lanbond0
rm -f /etc/sysconfig/network-scripts/ifcfg-lanbond0:0 
rm -f /etc/sysconfig/network-scripts/ifcfg-lanbond0:1 
rm -f /etc/sysconfig/network-scripts/ifcfg-lanbond0:2

#rename  /etc/dhclient-exit-hooks to use dhcp supplied or static nameservers
mv /etc/dhclient-exit-hooks /etc/dhclient-exit-hooks.rpmsave

# setup custom named
mv /sbin/ifup-local /sbin/ifup-local.rpmsave
cat > /sbin/ifup-local <<EOF
# Authors: Jerry Vonau <jvonau@shaw.ca>
#          Martin Langhoff <martin@laptop.org>
#  
if [ x"\${1}" = x ]; then
    exit
else
    case \$1 in
	eth0|ppp0)
            namedtpl=/etc/named-xs.conf.tpl
            namedconf=/etc/named-xs.conf
            FWD=""
            for i in \`cat /etc/resolv.conf | grep nameserver | awk  '{print \$2}'\`; 
            do 
                if [ x\$i != x127.0.0.1 ]; then
                    FWD="\$FWD \$i;"
		else
                    exit    
		fi
            done 
	    cp \$namedtpl \$namedconf 
            logger "changing /etc/named-xs.conf using forwarders \$FWD"
            sed -i -e "s/@@BASEDNSFWD@@/\$FWD/" \$namedconf

            logger "changing /etc/resolv.conf for principal school server"
	    cp /etc/sysconfig/olpc-scripts/resolv.conf /etc/resolv.conf  
	    ;;
    esac
fi
EOF
chmod 755 /sbin/ifup-local

# commit the changes
pushd /etc
git commit -a -m "custom changes done"
popd
%end
